package com.example.currency

import android.os.Bundle
import android.util.Log
import androidx.appcompat.app.AppCompatActivity
import androidx.appcompat.app.AppCompatDelegate
import com.example.currency.api.CurrencyApp
import com.example.currency.data.Response
import com.example.currency.selecter.MyDialogFragment
import com.jjoe64.graphview.series.DataPoint
import com.jjoe64.graphview.series.LineGraphSeries
import kotlinx.android.synthetic.main.activity_main.*
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.Job
import retrofit2.Call
import kotlin.coroutines.CoroutineContext
import kotlin.math.log

var test = arrayListOf(123.2829,123.36816975,123.5899977039,123.67547986084725,123.8978603881804,124.45540075992722,124.54148148084592,124.29239851788424,124.51588832489375,124.60201088259228,124.82605740271104,124.9123944917008,125.13699911170119,125.22355126637963,125.44871537648842,126.01323459568262,126.10039280668077,125.84819202106742,126.07447929593432,126.1616798673919,126.3885308238605,126.95727921256787,127.52858696902442,128.10246561038502,128.19106885720174,128.42156885222047,128.99946591205546,129.08868957736877,129.32080358164237,129.41024950310597,129.64294170336422,130.22633494102936,130.81235344826396,130.90283101389105,130.64102535186328,130.8759306066622,131.46487229439217,132.0564642197169,132.14780228598482,131.88350668141285,131.61973966805004,131.85640474626737,131.94760443956318,131.68370923068403,131.92048933238934,132.01173335037765,131.74770988367686,131.48421446390952,131.2212460349817,131.45719458293482,132.048751958558,132.14008469056964,132.37768539968675,132.9733849839853,133.0653572469207,132.79922653242687,133.03801244260845,133.1300294057191,133.36941013160296,133.9695724771952,134.57243555334253,134.6655138142897,134.90765549030593,135.51473994001228,136.12455626974233,136.21870806923752,136.46364253941027,136.55802887103798,136.80357347297593,136.89819492095575,137.14435117449713,137.2392083245038,137.48597775327278,137.58107119244016,137.8284553238562,138.44868337281355,138.54444267616407,138.26735379081174,137.99081908323012,138.23893998115904,138.33455421356646,138.05788510513932,137.78176933492904,137.5062057962592,137.75345531242002,137.84873375489767,138.09659916960325,138.1921149506811,138.44059779813472,138.53635150902323,138.78545332724985,138.88144556063222,138.60368266951093,138.85290555570506,138.9489444430407,139.19878814344432,139.8251826900898,140.45439601219522,140.55154258511297,140.27043949994274,139.98989862094285,140.2416140580826,140.87270132134395,140.97013721897045,141.2236152203354,141.8591214888269,141.95723965302142,142.2124925604556,142.8524487769776,142.95125398511354,143.20829422688104,143.852731550902,144.50006884288106,144.60001364256712,144.310813615282,144.57029847733995,144.67029185199766,144.38095126829364,144.6405622446653,144.74060421790296,144.45112300946715,144.16222076344823,144.42143844112343,144.52132885536997,144.78119224428025,144.88133148554869,144.59156882257759,144.30238568493246,144.56185539275288,145.21238374202028,145.86583946885935,145.9667289163419,146.22919127497624,146.3303320380725,146.59344819044222,147.2531187072992,147.35496767920765,147.06025774384923,146.76613722836154,147.03003700079998,147.13173167619738,147.39628882296896,147.49823681980274,147.76345297842695,147.86565492772087,148.13153173979617,148.23398827414582,148.50052738536002,148.6032391389367,148.87044219907696,148.97340980763178,149.24127847059484,149.34450257146258,149.61303849526504,149.71651972736805,149.98572457415676,150.66066033474047,151.33863330624678,151.44330806184846,151.14042144572474,151.41218660612898,151.51691223554602,151.78935436296484,152.47240645759817,153.15853228665736,153.26446579210258,152.95793686051837,152.65202098679734,152.92650415002186,153.61467341869698,154.3059394490811,155.00031617660196,155.69781759939667,156.39845777859395,157.1022508385976,157.2109120531979,156.8964902290915,156.5826972486333,156.86424814962496,157.57013726629825,158.2792028839966,158.99145929697457,159.10142719995537,158.78322434555545,158.46565789686431,158.1487265810706,158.43309335493504,158.54267505898403,158.22558970886607,157.90913852944834,157.59332025238945,157.87668835171957,158.58713344930229,159.30077554982415,159.41095739423193,159.69759378171875,159.80805008910096,159.48843398892274,159.1694571209449,158.851118206703,158.5334159702896,158.21634913834905,157.89991644007236,158.18383582913242,158.8956630903635,159.0055647350182,159.2914721871216,160.00828381196362,160.11895501095862,160.40686444693924,160.5178113278909,160.19677570523513,159.87638215382466,159.556629389517,159.84352770940276,159.9540849533263,159.63417678341963,159.3149084298528,158.99627861299308,158.6782860557671,158.96360502901146,159.073553666332,159.35958336913873,160.07670149429987,160.7970466510242,160.9082634050807,160.58644687827052,160.26527398451398,159.94474343654494,160.23233962319085,160.95338515149524,161.67767538467695,161.78950123368466,162.08041447406018,162.80977633919343,162.9223852162234,162.59654044579096,162.27134736489938,162.5631270114281,163.29466108297953,164.02948705785292,164.76761974961326,165.5090740384865,166.2538648716597,166.36885588415322,166.0361181723849,165.70404593604013,166.00199790807173,166.74900689865805,167.49937742970204,167.615229912395,167.9166183788794,168.03275945010674,167.69669393120654,167.36130054334413,167.02657794225743,167.32690795531454,168.07987904111346,168.83623849679844,168.95301563172603,168.61510960046257,168.27787938126167,168.58045935586466,169.33907142296604,170.10109724436938,170.86655218196904,171.6354516667879,172.4078111992884,173.1836463496852,173.96297275825876,174.74580613567093,175.53216226328144,175.65357069537663,175.30226355398588,175.6174740537203,176.40775268696203,177.20158757405335,177.99899471813657,178.79999019436818,179.60459015024284,179.72881531448675,179.36935768385777,179.69188121393847,179.81616675384825,179.45653442034055,179.09762135149987,178.7394261087969,179.06081696071047,179.86659063703365,180.67599029490032,180.80095650289388,180.4393545898881,180.76380207835146,181.57723918770404,182.39433676404872,183.2151112794869,184.0395792802446,184.16687194545068,184.4980218722317,184.62563162346677,184.95760644471542,185.08553407184084,185.4183358423692,185.54658213721382,185.17548897293938,184.8051379949935,185.13743558613643,185.97055404627403,186.09918228791088,185.72698392333507,186.0609390830105,186.89821330888407,187.02748317456937,187.3637767582365,188.20691375364854,189.05384486553993,189.18460569358848,189.52477799309997,189.6558645463712,189.27655281727843,188.89799971164388,188.52020371222056,188.85918135242576,188.98980753966768,189.32962957317466,190.18161290625395,190.3131537654251,190.65535530400342,190.7872238314548,190.40564938379188,190.0248380850243,190.3665212040006,191.2231705494186,192.08367481689098,192.21653125465093,192.56215525085983,192.69534263400627,193.04182757958972,193.91051580369788,194.04463579280383,194.39354689856486,195.2683178596084,196.14702528997663,196.28269218140863,196.63562752997396,196.77163236763252,197.12544687815114,197.26179050386028,196.86726692285256,196.47353238900686,196.08058532422888,196.43315726503118,197.31710647272382,197.4535826615517,197.80862338494734,198.69876219017962,198.83619401387344,199.1937208067953,199.331494973162,198.9328319832157,198.53496631924924,198.8919514755132,199.78696525715299,199.92514974649205,200.28463458760856,201.1859154432528,202.09125206274746,203.0006626970298,203.91416567916644,204.8317794247227,204.97345320611169,205.34201538726967,205.4840420780481,205.07307399389202,205.44181530290413,205.58391102121078,205.17274319916837,205.54166372309402,205.68382850247747,206.05366800742823,206.98090951346163,207.91232360627222,208.8479290625004,208.9923806506702,208.57439588936887,208.15724709759013,207.74093260339498,208.114470981358,208.25841526651,208.63288412857258,208.77718697893891,209.15258864293688,209.29725095170343,208.87865644980005,209.25424056576392,210.19588464830986,210.34126856234002,209.92058602521536,210.29804363177485,211.24438482811783,212.19498455984433,212.3417511696878,212.72356226638288,212.8706944718515,212.4449530829078,212.02006317674196,212.40129584717513,213.3571016784874,213.50467207730873,213.0776627331541,212.6515074076878,212.22620439287243,211.80175198408668,212.18259210978744,213.13741377428147,213.28483222394627,212.85826255949837,213.2410023938492,214.2005869046215,214.34874070774595,213.92004322633045,213.4922031398778,213.87608286097677,214.02401221789924,213.59596419346343,213.1687722650765,212.74243472054638,212.31694985110528,211.89231595140305,212.27331891991494,213.22854885505458,214.1880773249023,215.15192367286437,215.30073547680152,215.68786711473345,215.83704960887422,216.22514559171623,217.19815874687893,218.17555046123988,219.15734043831543,220.14354847028784,221.13419443840414,221.28714393485672,220.844569646987,221.24166963731668,221.39469346997762,221.79278263638318,221.9461876514113,222.3452684579304,223.34582216599105,224.35087836573803,224.50605271117058,224.05704060574826,223.60892652453677,224.0109970970777,225.01904658401455,226.0316322936426,226.1879691479652,225.73559320966928,226.14148773550664,226.29790057235454,225.84530477120984,225.39361416166741,225.79889377595467,225.95506965454408,225.503159515235,225.05215319620456,224.60204888981212,225.00590519284341,225.1615325935966,225.56639490267878,225.72240997128725,225.27096515134468,225.67602423079657,225.83211512553666,226.23818320715546,226.39466292431436,226.80174252152446,226.9586120296588,226.50469480559948,226.91197225082126,227.93307612594992,228.9587749685167,229.98908945587502,231.02404035842645,232.06364854003934,233.1079349584695,234.15692066578262,234.31887745042948,234.74020555516105,235.7965364801593,235.95962732014218,236.38390565253133,236.54740275179662,236.07430794629303,235.60215933040044,235.13095501173964,234.66069310171616,234.1913717155127,233.72298897208168,233.2555429941375,233.6749591202183,233.8365825517359,234.25704344338675,235.31120013888196,235.47395529152718,235.89736033842792,236.95889845995086,238.0252135030206,239.09632696378418,240.1722604351212,241.25303560707923,241.4199004847951,241.85399691877646,242.94233990491094,243.11037320545876,242.62415245904785,242.13890415412976,241.65462634582147,241.17131709312986,240.6889744589436,240.2075965100257,239.72718131700566,239.24772695437164,238.7692315004629,238.29169303746195,237.81510965138705,238.24272432125994,239.3148165807056,240.39173325531874,240.5580024053529,240.99054906285772,242.0750065336406,242.24243993509668,241.75795505522652,242.19265934416606,242.36017412126907,241.87545377302655,242.31036933607518,242.47796552837514,241.99300959731838,242.42813653715916,243.51906315157635,243.68749534805428,243.20012035735817,242.7137201166435,243.15014296401193,244.24431860734998,245.34341804108305,245.51311206937498,245.02208584523623,244.53204167354576,244.97173403971567,246.0741068428944,247.1814403236874,248.293756805144,249.41107871076713,250.53342856496556,250.70671231170073,250.20529888707733,249.70488828930317,249.20547851272457,248.70706755569913,248.20965342058773,248.65595848994306,248.82794366725838,249.2753604825415,250.3970996047129,251.52388655293413,251.69785535903293,251.19445964831488,250.69207072901824,250.1906865875602,250.64055374699865,251.76843623886012,252.90139420193498,254.03945047584367,255.18262800298496,256.33094982899837,257.48443910322885,257.66253058024006,257.1472055190796,257.6095811753529,257.78775920802764,258.25128664206073,258.42990851621477,257.91304869918235,257.397222601784,256.88242815658043,256.3686633002673,256.82963906199916,257.0072776405482,256.4932630852671,256.9544628895167,258.11075797251954,259.27225638339587,259.451584420648,259.9181035740469,261.0877350401301,262.2626298478107,263.4428116821258,264.6283043346954,265.8191317042015,267.01531779687036,268.21688672695626,268.4024013999319,267.865596597132,268.3472449618095,269.5548075641376,269.7412476223476,269.2017651271029,268.66336159684863,268.12603487365493,268.6081515316541,268.7939368265252,269.27725443711944,269.4635025231601,268.9245755181138,268.38672636707753,268.8693117737069,269.0552777024579,268.517167147053,267.9801328127589,268.4619871246787,269.67006606673976,269.8565858445516,270.341814201312,270.5287985998903,269.9877410026906,270.4732051891665,270.6602804655283,270.1189599045972,269.578721984788,269.03956454081845,269.5233238139046,269.7097420960896,270.194706413525,270.38158906365095,270.8677614272012,272.0866663536235,273.3110563522148,273.50009445439593,272.95309426548715,272.40718807695623,271.8623737008023,271.3186489534007,270.77601165549396,271.26289322918075,271.4505147005278,271.93860909621463,273.1623328371476,273.3512680733437,272.804565537197,273.2950946478284,274.52492257374365,275.76028472532545,275.95101685880434,275.3991148250867,274.8483165954366,275.3425205690124,276.5815619115729,276.77286208896015,277.2705265822946,278.51824395191494,278.7108836532216,279.2120328975991,280.4684870456383,281.73059523734366,281.92545679091876,281.36160587733696,280.7988826655823,280.2372849002511,280.74117876235414,282.0045140667847,282.1995650788338,282.70698731132507,283.979168754226,284.17558555432464,283.607234383216,283.04001991444954,283.54895336638185,284.82492365653053,285.02192543077473,285.534422541359,286.8193274427951,288.11001441628764,289.40650948116087,290.7088387738261,290.90991021199824,291.4329944912117,291.6345667983363,292.15895408048925,292.361028504231,291.7763064472225,292.30094859103355,292.5031212265825,291.9181149841294,291.3342787541611,291.8581260892389,292.0599924425377,291.47587245765266,290.89292071273735,290.3111348713119,290.83314249429424,291.03429990827624,290.4522313084597,290.974492636543,292.28387785340743,292.48603868182397,293.01195699314025,294.3305107996094,294.53408720049924,295.0636881020112,296.3914746984703,297.7252363346134,299.06499989811914,300.41079239766066,300.6185742811583,300.01733713259597,299.41730245833077,299.95568385525985)

class MainActivity : AppCompatActivity(), CoroutineScope {
    private lateinit var job: Job
    private val service = CurrencyApp.create()

    override val coroutineContext: CoroutineContext
        get() = job + Dispatchers.Main

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        supportActionBar?.hide()
        AppCompatDelegate.setDefaultNightMode(AppCompatDelegate.MODE_NIGHT_NO)

        val manager = supportFragmentManager

        buttonConvert.setOnClickListener {
            updateGraph(test)
            service.getRates(buttonBase.text.toString(), "sandbox_c9farriad3iampagd6cg")
                .enqueue(
                    object : retrofit2.Callback<Response> {
                        override fun onResponse(
                            call: Call<Response>,
                            response: retrofit2.Response<Response>
                        ) {
                            val result =
                                response.body()?.quote?.get(buttonCurrency.text.toString())
                                    ?.toDouble()
                                    ?.times(textViewBase.text.toString().toDouble())
                            textViewValue.text = result.toString()
                        }

                        override fun onFailure(call: Call<Response>, t: Throwable) {
                        }
                    }
                )
        }

        buttonBase.setOnClickListener {
            val myDialogFragment = MyDialogFragment(true)
            myDialogFragment.show(manager, "myDialog")
        }

        buttonCurrency.setOnClickListener {
            val myDialogFragment = MyDialogFragment()
            myDialogFragment.show(manager, "myDialog")
        }

        button1.setOnClickListener { appendValue("1") }
        button2.setOnClickListener { appendValue("2") }
        button3.setOnClickListener { appendValue("3") }
        button4.setOnClickListener { appendValue("4") }
        button5.setOnClickListener { appendValue("5") }
        button6.setOnClickListener { appendValue("6") }
        button7.setOnClickListener { appendValue("7") }
        button8.setOnClickListener { appendValue("8") }
        button9.setOnClickListener { appendValue("9") }
        button0.setOnClickListener { appendValue("0") }

        buttonDelete.setOnClickListener { appendValue("", true) }
    }


    private fun appendValue(string: String, isClear: Boolean = false) {
        if (isClear && textViewBase.text.isNotEmpty()) {
            textViewBase.text = textViewBase.text.substring(0, textViewBase.text.length - 1)
        }
        if (textViewBase.text.isNotEmpty() && textViewBase.text[0] == '0') {
            textViewBase.text = ""
        }
        textViewBase.append(string)

        if (textViewBase.text.isEmpty()) {
            textViewBase.text = "0"
        }
    }

    fun getDataFromFragment(base:Boolean, currency:String){
        if (base){
            buttonBase.text = currency
        }
        buttonCurrency.text = currency
    }

    fun updateGraph(array: ArrayList<Double>){
        var arrayData = arrayOf<com.jjoe64.graphview.series.DataPoint>()
        for(i in 0..array.size-2){
            arrayData+=DataPoint(i.toDouble(), array[i])
        }
        graph.addSeries(LineGraphSeries(arrayData))
    }
}

